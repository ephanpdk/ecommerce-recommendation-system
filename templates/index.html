<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartShop AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .slider-thumb::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; border-radius: 50%; background: #f97316; cursor: pointer; }
        .shimmer { background: #f6f7f8; background-image: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%); background-repeat: no-repeat; background-size: 800px 104px; animation: placeholderShimmer 1s linear infinite forwards; }
        @keyframes placeholderShimmer { 0% { background-position: -468px 0; } 100% { background-position: 468px 0; } }
    </style>
</head>
<body class="text-gray-800">

<div id="toastContainer" class="fixed top-5 right-5 z-[100] space-y-2"></div>

<nav class="bg-white shadow-sm sticky top-0 z-50 border-b border-gray-100">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16 items-center">
            <div onclick="location.reload()" class="flex items-center gap-3 cursor-pointer">
                <div class="bg-orange-500 text-white p-2 rounded-lg"><i class="fa-solid fa-brain text-xl"></i></div>
                <span class="font-bold text-xl text-gray-900">SmartShop<span class="text-orange-500">AI</span></span>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="showModelInsights()" class="text-sm font-medium text-gray-500 hover:text-orange-600 flex items-center gap-1">
                    <i class="fa-solid fa-chart-radar"></i> Model Insights
                </button>
                <div id="authBtnArea"></div>
            </div>
        </div>
    </div>
</nav>

<div id="authModal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-2xl w-full max-w-sm p-8 relative shadow-2xl">
        <button onclick="toggleModal('authModal')" class="absolute top-4 right-4 text-gray-300 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
        <div class="flex border-b border-gray-100 mb-6">
            <button onclick="switchAuthTab('login')" id="tabLogin" class="w-1/2 py-3 font-bold text-orange-600 border-b-2 border-orange-600">Login</button>
            <button onclick="switchAuthTab('register')" id="tabRegister" class="w-1/2 py-3 font-bold text-gray-400">Register</button>
        </div>
        <div id="loginForm" class="space-y-4">
            <input type="email" id="loginEmail" placeholder="admin@toko.com" class="w-full p-3 border rounded-lg text-sm">
            <input type="password" id="loginPass" placeholder="••••••••" class="w-full p-3 border rounded-lg text-sm">
            <button onclick="handleLogin()" class="w-full bg-orange-600 text-white font-bold py-3 rounded-lg">Access System</button>
        </div>
        <div id="registerForm" class="space-y-4 hidden">
            <input type="text" id="regName" placeholder="Full Name" class="w-full p-3 border rounded-lg text-sm">
            <input type="email" id="regEmail" placeholder="Email" class="w-full p-3 border rounded-lg text-sm">
            <input type="password" id="regPass" placeholder="Password" class="w-full p-3 border rounded-lg text-sm">
            <button onclick="handleRegister()" class="w-full bg-gray-900 text-white font-bold py-3 rounded-lg">Create Account</button>
        </div>
    </div>
</div>

<div id="insightsModal" class="fixed inset-0 bg-black/80 z-[70] hidden flex items-center justify-center backdrop-blur-md">
    <div class="bg-white rounded-2xl w-full max-w-4xl p-6 relative shadow-2xl h-[90vh] overflow-y-auto">
        <button onclick="toggleModal('insightsModal')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 text-xl"><i class="fa-solid fa-xmark"></i></button>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2">
                <h3 class="text-xl font-bold mb-1">Cluster Centroids Visualization</h3>
                <div class="h-80 w-full relative"><canvas id="radarChart"></canvas></div>
            </div>
            <div class="space-y-4 overflow-y-auto pr-2">
                <h3 class="text-lg font-bold">Cluster Profiling</h3>
                <div id="clusterProfiles" class="space-y-3 text-sm">
                    <div class="animate-pulse bg-gray-100 h-20 rounded"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

        <div class="lg:col-span-4 space-y-6">
            <div class="bg-white rounded-xl shadow-sm border p-6 sticky top-24">
                <div class="mb-6 pb-4 border-b">
                    <h3 class="font-bold text-gray-900 flex items-center gap-2">
                        <i class="fa-solid fa-sliders text-orange-500"></i> Behavior Simulator
                    </h3>
                </div>

                <div class="space-y-5">
                    <div>
                        <label class="text-xs font-bold text-gray-600 uppercase flex justify-between">
                            Monetary <span id="valMoney" class="text-orange-600">$1000</span>
                        </label>
                        <input type="range" id="inMoney" min="10" max="10000" step="50" value="1000" class="w-full h-2 bg-gray-200 slider-thumb">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-semibold text-gray-500 uppercase">Frequency</label>
                            <input type="number" id="inFreq" value="5" min="1" class="w-full p-2 border rounded text-sm">
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-500 uppercase">Recency</label>
                            <input type="number" id="inRec" value="30" min="0" max="365" class="w-full p-2 border rounded text-sm">
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase flex justify-between">
                            Page Views <span id="valViews">50</span>
                        </label>
                        <input type="range" id="inViews" min="1" max="500" value="50" class="w-full h-1.5 bg-gray-200">
                    </div>

                    <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase flex justify-between">
                            Add to Cart <span id="valCart">15</span>
                        </label>
                        <input type="range" id="inCart" min="0" max="50" value="15" class="w-full h-1.5 bg-gray-200">
                    </div>

                    <div class="grid grid-cols-2 gap-3 bg-gray-50 p-3 rounded-lg">
                        <div>
                            <label class="text-[10px] text-gray-500 uppercase">Avg Items</label>
                            <input type="number" id="inAvg" value="3.5" step="0.1" class="w-full p-1.5 text-xs border rounded bg-white">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-500 uppercase">Wishlist</label>
                            <input type="number" id="inWish" value="2" class="w-full p-1.5 text-xs border rounded bg-white">
                        </div>
                    </div>

                    <button onclick="getPrediction()" class="w-full bg-gray-900 text-white font-bold py-3 rounded-lg shadow-lg flex justify-center items-center gap-2">
                        <i class="fa-solid fa-bolt"></i> Run Prediction
                    </button>
                </div>
            </div>
        </div>

        <div class="lg:col-span-8">
            <div id="resultState" class="hidden space-y-6">
                <div class="bg-white rounded-xl shadow-sm border p-6">
                    <div class="flex items-start md:items-center justify-between gap-4 mb-4 border-b pb-4">
                        <div class="flex items-center gap-4">
                            <div id="personaIcon" class="h-14 w-14 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 text-2xl">
                                <i class="fa-solid fa-user"></i>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 uppercase font-bold">AI Detected Persona</div>
                                <div id="personaResult" class="text-3xl font-bold text-gray-900">Loading...</div>
                            </div>
                        </div>
                        <div><span class="bg-green-100 text-green-800 text-xs font-bold px-3 py-1 rounded-full">High Confidence</span></div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="text-sm font-bold text-gray-700 mb-2"><i class="fa-solid fa-lightbulb text-yellow-500 mr-1"></i> Why this cluster?</h4>
                        <p id="explainText" class="text-sm text-gray-600">Analyzing...</p>
                    </div>
                </div>

                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-gray-900 text-lg">Curated Products</h3>
                    </div>
                    <div id="recGrid" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                </div>
            </div>

            <div id="emptyState" class="h-96 flex flex-col items-center justify-center text-center p-8 bg-white rounded-xl border-2 border-dashed border-gray-200">
                <div class="bg-gray-50 p-6 rounded-full mb-4"><i class="fa-solid fa-robot text-5xl text-gray-300"></i></div>
                <h3 class="text-xl font-bold text-gray-900">Ready to Analyze</h3>
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = "http://localhost:8000";
    let token = localStorage.getItem('access_token');
    let metricsData = null;
    let chartInstance = null;

    async function init() {
        updateAuthUI();
        setupInterdependentInputs();
        await fetchMetricsData();
    }

    async function fetchMetricsData() {
        try {
            const res = await fetch(`${API_URL}/cluster/metrics`);
            if(res.ok) metricsData = await res.json();
        } catch {}
    }

    function updateAuthUI() {
        const btnArea = document.getElementById('authBtnArea');
        if(!btnArea) return;

        if(token) {
            btnArea.innerHTML = `
                <button onclick="logout()" class="text-red-500 text-xs font-bold border border-red-100 bg-red-50 px-3 py-1.5 rounded">Logout</button>
            `;
        } else {
            btnArea.innerHTML = `
                <button onclick="toggleModal('authModal')" class="bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-bold">Sign In</button>
            `;
        }
    }

    function setupInterdependentInputs() {
        const inMoney = document.getElementById('inMoney');
        const inViews = document.getElementById('inViews');
        const inCart = document.getElementById('inCart');

        inMoney.addEventListener('input', (e) => document.getElementById('valMoney').innerText = '$' + e.target.value);
        inViews.addEventListener('input', (e) => {
            const val = parseInt(e.target.value);
            document.getElementById('valViews').innerText = val;
            inCart.max = val;
        });
        inCart.addEventListener('input', (e) => document.getElementById('valCart').innerText = e.target.value);
    }

    async function getPrediction() {
        if(!token) { toggleModal('authModal'); showToast('Please login first', 'error'); return; }

        const payload = {
            Monetary: parseFloat(inMoney.value),
            Frequency: parseInt(inFreq.value),
            Recency: parseInt(inRec.value),
            Page_Views: parseInt(inViews.value),
            Add_to_Cart_Count: parseInt(inCart.value),
            Avg_Items: parseFloat(inAvg.value),
            Wishlist_Count: parseInt(inWish.value),
            Unique_Products: Math.max(1, Math.ceil(parseInt(inFreq.value) * 0.6))
        };

        emptyState.classList.add('hidden');
        resultState.classList.remove('hidden');
        personaResult.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin text-orange-500"></i>';

        try {
            const res = await fetch(`${API_URL}/recommend/user`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(payload)
            });

            if(res.ok) renderResults(await res.json(), payload);
        } catch {}
    }

    function renderResults(data, input) {
        const clusters = ["Newbie (Hemat)", "Window Shopper", "Loyalist", "Sultan (High Spender)"];
        const icons = ["fa-seedling", "fa-eye", "fa-handshake", "fa-crown"];

        personaResult.innerText = clusters[data.cluster];
        personaIcon.innerHTML = `<i class="fa-solid ${icons[data.cluster]}"></i>`;
        explainText.innerHTML = `User dikategorikan sebagai <b>${clusters[data.cluster]}</b> karena Monetary <b>$${input.Monetary}</b> dan Recency <b>${input.Recency} hari</b>.`;

        recGrid.innerHTML = data.recommendations.map(item => {
            return `
                <div class="bg-white rounded-lg p-3 border hover:shadow-md transition">
                    <div class="h-32 bg-gray-100 rounded mb-3">
                        <img src="https://picsum.photos/seed/${item.product_id}/200/200" class="w-full h-full object-cover rounded">
                    </div>
                    <h4 class="font-bold text-sm mt-2 truncate">${item.name}</h4>
                </div>
            `;
        }).join('');
    }

    function getColor(i) { return ['107, 114, 128', '59, 130, 246', '16, 185, 129', '245, 158, 11'][i]; }

    async function showModelInsights() {
        if(!metricsData) await fetchMetricsData();
        if(!metricsData) return showToast('Metrics not ready', 'error');

        toggleModal('insightsModal');
        clusterProfiles.innerHTML = metricsData.centroids_real.map((c, i) => `
            <div class="p-3 bg-gray-50 rounded border">
                <div class="font-bold text-orange-600 text-xs mb-1">Cluster ${i} (${metricsData.cluster_names[i]})</div>
                <div class="grid grid-cols-2 gap-2 text-xs text-gray-600">
                    <div>Money: $${Math.round(c.Monetary)}</div>
                    <div>Freq: ${Math.round(c.Frequency)}</div>
                    <div>Recency: ${Math.round(c.Recency)}</div>
                    <div>Views: ${Math.round(c.Page_Views)}</div>
                </div>
            </div>
        `).join('');

        const ctx = document.getElementById('radarChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: metricsData.feature_readable,
                datasets: metricsData.centroids_scaled.map((d, i) => ({
                    label: metricsData.cluster_names[i],
                    data: d,
                    fill: true,
                    backgroundColor: `rgba(${getColor(i)},0.2)`,
                    borderColor: `rgba(${getColor(i)},1)`
                }))
            },
            options: { scales:{r:{suggestedMin:-1,suggestedMax:3}} }
        });
    }

    function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }

    function showToast(msg, type='info') {
        const t = document.createElement('div');
        t.className = `px-6 py-3 rounded-lg text-white shadow-lg mb-2 text-sm transform transition translate-x-full opacity-0 ${type=='error'?'bg-red-500':'bg-gray-800'}`;
        t.innerText = msg;
        toastContainer.appendChild(t);
        setTimeout(() => t.classList.remove('translate-x-full', 'opacity-0'), 10);
        setTimeout(() => t.remove(), 3000);
    }

    async function handleLogin() {
        const e = loginEmail.value;
        const p = loginPass.value;
        try {
            const res = await fetch(`${API_URL}/auth/login`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({email:e, password:p})
            });
            if(res.ok) {
                const d=await res.json();
                localStorage.setItem('access_token', d.access_token);
                token=d.access_token;
                location.reload();
            }
        } catch {}
    }

    async function handleRegister() {
        const n = regName.value;
        const e = regEmail.value;
        const p = regPass.value;
        try {
            const res = await fetch(`${API_URL}/auth/register`, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({name:n,email:e,password:p})
            });
            if(res.ok) {
                showToast('Registered!');
                toggleModal('authModal');
            }
        } catch {}
    }

    function logout() {
        localStorage.removeItem('access_token');
        location.reload();
    }

    function switchAuthTab(t) {
        loginForm.classList.toggle('hidden', t!=='login');
        registerForm.classList.toggle('hidden', t==='login');
        tabLogin.className = t==='login' ? "w-1/2 py-3 font-bold text-orange-600 border-b-2 border-orange-600" : "w-1/2 py-3 font-bold text-gray-400";
        tabRegister.className = t!=='login' ? "w-1/2 py-3 font-bold text-orange-600 border-b-2 border-orange-600" : "w-1/2 py-3 font-bold text-gray-400";
    }

    init();
</script>

</body>
</html>
